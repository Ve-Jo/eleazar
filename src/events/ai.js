import {
  Events,
  StringSelectMenuBuilder,
  ButtonBuilder,
  ActionRowBuilder,
  ComponentType,
  InteractionType,
} from "discord.js";
import { translate } from "bing-translate-api";
import { Memer } from "memer.ts";
import hubClient from "../api/hubClient.js";
import fetch from "node-fetch";
import { Groq } from "groq-sdk";
import CONFIG from "../config/aiConfig.js";
import i18n from "../utils/i18n.js";
import OpenAI from "openai";

// Import everything from the unified AI API
import {
  // State
  state,

  // User preferences
  getUserPreferences,
  updateUserPreference,

  // Model status
  isModelRateLimited,

  // Model management
  getAvailableModels,
  initializeApiClients,

  // UI components
  buildInteractionComponents,
} from "../ai.js";

import processAiRequest from "../handlers/processAiRequest.js";

// --- Start Localization Definitions ---
const localization_strings = {
  messages: {
    processing: {
      en: "Processing your request with `{model}`...",
      ru: "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å —Å `{model}`...",
      uk: "–û–±—Ä–æ–±–ª—è—é –≤–∞—à –∑–∞–ø–∏—Ç –∑ `{model}`...",
    },
    rateLimited: {
      en: "Model `{model}` is currently rate-limited. Please try again in about {minutes} minute(s) or select a different model.",
      ru: "–ú–æ–¥–µ–ª—å `{model}` –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –æ–±–º–µ–∂–µ–Ω–∞. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ {minutes} —Ö–≤–∏–ª–∏–Ω –∞–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—É –º–æ–¥–µ–ª—å.",
      uk: "–ú–æ–¥–µ–ª—å `{model}` –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –æ–±–º–µ–∂–µ–Ω–∞. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ {minutes} —Ö–≤–∏–ª–∏–Ω –∞–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—É –º–æ–¥–µ–ª—å.",
    },
    streamStart: {
      en: "Thinking...",
      ru: "–î—É–º–∞—é...",
      uk: "–î—É–º–∞—é...",
    },
    streamProcessing: {
      en: "Processing...",
      ru: "–û–±—Ä–∞–±–æ—Ç–∫–∞...",
      uk: "–û–±—Ä–æ–±–∫–∞...",
    },
    streamStopped: {
      en: "Generation stopped.",
      ru: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.",
      uk: "–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑—É–ø–∏–Ω–µ–Ω–∞.",
    },
    streamError: {
      en: "Error during streaming: {error}",
      ru: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–µ: {error}",
      uk: "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —Å—Ç—Ä—ñ–º—ñ–Ω–≥—É: {error}",
    },
    visionMismatch: {
      en: "Model `{model}` does not support image input. Please select a model with 'Vision' capability for this request.",
      ru: "–ú–æ–¥–µ–ª—å `{model}` –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å –∑ 'Vision' —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É.",
      uk: "–ú–æ–¥–µ–ª—å `{model}` –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å –∑ 'Vision' —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–æ–º –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É.",
    },
    errorOccurred: {
      en: "üò• An error occurred: {error}",
      ru: "üò• –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {error}",
      uk: "üò• –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: {error}",
    },
    modelDetailsError: {
      en: "üò• Error checking model details: {error}",
      ru: "üò• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–µ—Ç–∞–ª–µ–π –º–æ–¥–µ–ª–∏: {error}",
      uk: "üò• –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –¥–µ—Ç–∞–ª–µ–π –º–æ–¥–µ–ª—ñ: {error}",
    },
    noModelsFound: {
      en: "Sorry, I couldn't find any suitable AI models to use right now{vision, select, vision { for image analysis} other {}}.",
      ru: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç{vision, select, vision { –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π} other {}}.",
      uk: "–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑–º—ñ–≥ –∑–Ω–∞–π—Ç–∏ –ø—ñ–¥—Ö–æ–¥—è—â—ñ –º–æ–¥–µ–ª—ñ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç{vision, select, vision { –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –∑–æ–±—Ä–∞–∂–µ–Ω—å} other {}}.",
    },
    selectModelPrompt: {
      en: "Please select an AI model to use for this chat. You can also configure context memory and tool usage below.",
      ru: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∏–∂–µ.",
      uk: "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —Ü—å–æ–º—É —á–∞—Ç—ñ. –í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É –ø–∞–º—è—Ç—å —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –Ω–∏–∂—á–µ.",
    },
    modelSelectedProcessing: {
      en: "Model selected: `{model}`. Processing your request...",
      ru: "–ú–æ–¥–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞: `{model}`. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å...",
      uk: "–ú–æ–¥–µ–ª—å –≤–∏–±—Ä–∞–Ω–∞: `{model}`. –û–±—Ä–æ–±–ª—è—é –≤–∞—à –∑–∞–ø–∏—Ç...",
    },
    selectionTimeout: {
      en: "Model selection timed out.",
      ru: "–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.",
      uk: "–í–∏–±—ñ—Ä –º–æ–¥–µ–ª—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.",
    },
    selectionError: {
      en: "Sorry, I encountered an error while preparing model selection options.",
      ru: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏.",
      uk: "–í–∏–±–∞—á—Ç–µ, —è –∑—É—Å—Ç—Ä—ñ–≤ –ø–æ–º–∏–ª–∫—É –ø—Ä–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤—Ü—ñ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –≤–∏–±–æ—Ä—É –º–æ–¥–µ–ª—ñ.",
    },
    toolComplete: {
      en: "Tool actions completed.",
      ru: "–î–µ–π—Å—Ç–≤–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.",
      uk: "–î—ñ—ó —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.",
    },
    noTextResponse: {
      en: "I didn't get a text response for that.",
      ru: "–Ø –Ω–µ –ø–æ–ª—É—á–∏–ª —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å.",
      uk: "–Ø –Ω–µ –æ—Ç—Ä–∏–º–∞–≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ —Ü–µ–π –∑–∞–ø–∏—Ç.",
    },
    noTextResponseInternal: {
      en: "(No text response received)",
      ru: "(–ù–µ –ø–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç)",
      uk: "(–ù–µ –æ—Ç—Ä–∏–º–∞–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ)",
    },
    emptyResponseInternal: {
      en: "(Received an empty response from the AI)",
      ru: "(–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç AI)",
      uk: "(–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ AI)",
    },
    toolsDisabledNote: {
      en: "*(AI tried to use tools, but they are currently disabled.)*",
      ru: "*(AI –ø–æ–ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –Ω–æ –æ–Ω–∏ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω—ã.)*",
      uk: "*(AI —Å–ø—Ä–æ–±—É–≤–∞–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, –∞–ª–µ –≤–æ–Ω–∏ –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –≤—ñ–¥–∫–ª—é—á–µ–Ω—ñ.)*",
    },
    reasoningDisabled: {
      en: "*(AI tried to use reasoning, but it is currently disabled.)*",
      ru: "*(AI –ø–æ–ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ, –Ω–æ –æ–Ω–æ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω–æ.)*",
      uk: "*(AI —Å–ø—Ä–æ–±—É–≤–∞–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è, –∞–ª–µ –≤–æ–Ω–æ –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –≤–∏–º–∫–Ω–µ–Ω–æ.)*",
    },
  },
  buttons: {
    systemPrompt: {
      on: {
        en: "System Prompt: ON",
        ru: "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç: –í–ö–õ",
        uk: "–°–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: –í–ö–õ",
      },
      off: {
        en: "System Prompt: OFF",
        ru: "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç: –í–´–ö–õ",
        uk: "–°–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: –í–ò–ö–õ",
      },
      tools: {
        on: {
          en: "Tools: ON",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –í–ö–õ",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: –í–ö–õ",
        },
        off: {
          en: "Tools: OFF",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –í–´–ö–õ",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: –í–ò–ú–ö",
        },
        offModel: {
          en: "Tools: OFF (Model)",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –í–´–ö–õ (–ú–æ–¥–µ–ª—å)",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: –í–ò–ú–ö (–ú–æ–¥–µ–ª—å)",
        },
      },
      reasoning: {
        on: {
          en: "Reasoning: ON",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í–ö–õ",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è: –í–ö–õ",
        },
        off: {
          en: "Reasoning: OFF",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í–´–ö–õ",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è: –í–ò–ú–ö",
        },
        offModel: {
          en: "Reasoning: OFF (Model)",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í–´–ö–õ (–ú–æ–¥–µ–ª—å)",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è: –í–ò–ú–ö (–ú–æ–¥–µ–ª—å)",
        },
      },
      clearContext: {
        en: "Context ({current}/{max})",
        ru: "–ö–æ–Ω—Ç–µ–∫—Å—Ç ({current}/{max})",
        uk: "–ö–æ–Ω—Ç–µ–∫—Å—Ç ({current}/{max})",
      },
    },
    menus: {
      modelSelect: {
        placeholder: {
          en: "Select an AI model",
          ru: "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å AI",
          uk: "–í–∏–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å AI",
        },
        visionSupport: {
          en: "Images",
          ru: "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
          uk: "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è",
        },
        reasoningSupport: {
          en: "Reasoning",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
        },
      },
      settingsSelect: {
        placeholder: {
          en: "Settings",
          ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
          uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
        },
        systemPrompt: {
          en: "System Prompt",
          ru: "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç",
          uk: "–°–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
        },
        systemPromptEnabled: {
          en: "System instructions enabled",
          ru: "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã",
          uk: "–°–∏—Å—Ç–µ–º–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —É–≤—ñ–º–∫–Ω–µ–Ω–æ",
        },
        systemPromptDisabled: {
          en: "System instructions disabled",
          ru: "–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã",
          uk: "–°–∏—Å—Ç–µ–º–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –≤–∏–º–∫–Ω–µ–Ω–æ",
        },
        tools: {
          en: "AI Tools",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ò–ò",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –®–Ü",
        },
        toolsEnabled: {
          en: "Tools enabled",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ",
        },
        toolsDisabled: {
          en: "Tools disabled",
          ru: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã",
          uk: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –≤–∏–º–∫–Ω–µ–Ω–æ",
        },
        webSearch: {
          en: "Web Search",
          ru: "–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
          uk: "–ü–æ—à—É–∫ –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ",
        },
        webSearchEnabled: {
          en: "Web search enabled",
          ru: "–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –≤–∫–ª—é—á–µ–Ω",
          uk: "–ü–æ—à—É–∫ –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ —É–≤—ñ–º–∫–Ω–µ–Ω–æ",
        },
        webSearchDisabled: {
          en: "Web search disabled",
          ru: "–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –æ—Ç–∫–ª—é—á–µ–Ω",
          uk: "–ü–æ—à—É–∫ –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ –≤–∏–º–∫–Ω–µ–Ω–æ",
        },
        reasoning: {
          en: "AI Reasoning",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –ò–ò",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –®–Ü",
        },
        reasoningOff: {
          en: "Reasoning disabled",
          ru: "–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ",
          uk: "–ú—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ",
        },
      },
      settingsOptions: {
        systemPrompt: {
          en: "Toggle system instructions for AI",
          ru: "–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò",
          uk: "–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –®–Ü",
        },
        tools: {
          en: "Toggle AI tools functionality",
          ru: "–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ò–ò",
          uk: "–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –®–Ü",
        },
        reasoning: {
          en: "Toggle AI reasoning capabilities",
          ru: "–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –ò–ò",
          uk: "–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –®–Ü",
        },
        clearContext: {
          en: "Clear conversation history",
          ru: "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞",
          uk: "–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ä–æ–∑–º–æ–≤–∏",
        },
        finetune: {
          en: "Adjust AI generation parameters",
          ru: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ò–ò",
          uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –®–Ü",
        },
        switchModel: {
          label: {
            en: "Switch Model",
            ru: "–°–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å",
            uk: "–ó–º—ñ–Ω–∏—Ç–∏ –º–æ–¥–µ–ª—å",
          },
          description: {
            en: "Change the AI model",
            ru: "–ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞",
            uk: "–ó–º—ñ–Ω–∏—Ç–∏ –º–æ–¥–µ–ª—å —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É",
          },
        },
        reasoningSettings: {
          en: "Configure AI reasoning parameters",
          ru: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –ò–ò",
          uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –®–Ü",
        },
      },
    },
    toolResult: {
      successPrefix: {
        en: "üîß **Tool Result ({command}):**",
        ru: "üîß **–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ({command}):**",
        uk: "üîß **–†–µ–∑—É–ª—å—Ç–∞—Ç —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É ({command}):**",
      },
      errorPrefix: {
        en: "‚ö†Ô∏è **Tool Error ({command}):**",
        ru: "‚ö†Ô∏è **–û—à–∏–±–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ({command}):**",
        uk: "‚ö†Ô∏è **–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É ({command}):**",
      },
    },
    toolExec: {
      parseError: {
        en: "Error: Could not parse the arguments provided for the command {command}. Please ensure arguments are a valid JSON string. Received: {args}",
        ru: "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã {command}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —è–≤–ª—è—é—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º–æ–π —Å—Ç—Ä–æ–∫–æ–π JSON. –ü–æ–ª—É—á–µ–Ω–æ: {args}",
        uk: "–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∏, –Ω–∞–¥–∞–Ω—ñ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ {command}. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ —î –¥–æ–ø—É—Å—Ç–∏–º–æ—é —Ä—è–¥–∫–æ–≤–æ—é —Å—Ç—Ä–æ–∫–æ—é JSON. –û—Ç—Ä–∏–º–∞–Ω–æ: {args}",
      },
      commandNotFound: {
        en: 'Command "{command}" not found.',
        ru: '–ö–æ–º–∞–Ω–¥–∞ "{command}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.',
        uk: '–ö–æ–º–∞–Ω–¥–∞ "{command}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.',
      },
      dmRestricted: {
        en: "Error: This command can only be used in servers, not in DMs.",
        ru: "–û—à–∏–±–∫–∞: –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∞ –Ω–µ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.",
        uk: "–ü–æ–º–∏–ª–∫–∞: –¶—è –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ —Ç—ñ–ª—å–∫–∏ –≤ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∞ –Ω–µ –≤ –æ—Å–æ–±–∏—Å—Ç–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö.",
      },
      economyDepositError: {
        en: "The 'deposit' command is for your own bank. Use 'transfer' to send money to someone else.",
        ru: "–ö–æ–º–∞–Ω–¥–∞ 'deposit' –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'transfer', —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –∫–æ–º—É-–ª–∏–±–æ –¥—Ä—É–≥–æ–º—É.",
        uk: "–ö–æ–º–∞–Ω–¥–∞ 'deposit' –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–∞—à–æ–≥–æ –≤–ª–∞—Å–Ω–æ–≥–æ –±–∞–Ω–∫—É. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ 'transfer', —â–æ–± –ø–µ—Ä–µ–¥–∞—Ç–∏ –≥—Ä–æ—à—ñ —ñ–Ω—à–æ–º—É.",
      },
      economyTransferError: {
        en: "To put money in your bank, use the 'deposit' command.",
        ru: "–ß—Ç–æ–±—ã –ø–æ–ª–æ–∂–∏—Ç—å –¥–µ–Ω—å–≥–∏ –≤ –≤–∞—à –±–∞–Ω–∫, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É 'deposit'.",
        uk: "–©–æ–± –ø–æ–∫–ª–∞—Å—Ç–∏ –≥—Ä–æ—à—ñ –≤ –≤–∞—à –±–∞–Ω–∫, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É 'deposit'.",
      },
      economyWithdrawError: {
        en: "The 'withdraw' command is only for your own bank.",
        ru: "–ö–æ–º–∞–Ω–¥–∞ 'withdraw' –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–∞.",
        uk: "–ö–æ–º–∞–Ω–¥–∞ 'withdraw' –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≤–∞—à–æ–≥–æ –≤–ª–∞—Å–Ω–æ–≥–æ –±–∞–Ω–∫—É.",
      },
      missingParams: {
        en: "Error: Missing required parameters for command '{command}': {missing}. Required: {required}. Please provide values for these.",
        ru: "–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã '{command}': {missing}. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: {required}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —ç—Ç–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.",
        uk: "–ü–æ–º–∏–ª–∫–∞: –í—ñ–¥—Å—É—Ç–Ω—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ '{command}': {missing}. –û–±–æ–≤'—è–∑–∫–æ–≤–æ: {required}. –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ü–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.",
      },
      userNotFound: {
        en: "Error: Could not find the user specified: {user}. Please provide a valid user mention, ID, or username.",
        ru: "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, ID –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
        uk: "–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {user}. –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥–∞–π—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º–∏–π —É–ø–æ–º–∏–Ω–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, ID –∞–±–æ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.",
      },
      missingPermissions: {
        en: "I seem to be missing the required permissions to do that.",
        ru: "–Ø –∫–∞–∂—É—Å—å, —á—Ç–æ —É –º–µ–Ω—è –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ.",
        uk: "–Ø –∑–¥–∞—é—Å—å, —â–æ —É –º–µ–Ω–µ –Ω–µ–º–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤ –¥–ª—è —Ü—å–æ–≥–æ.",
      },
      errorGeneric: {
        en: "An error occurred while running the command: {error}",
        ru: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã: {error}",
        uk: "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –∫–æ–º–∞–Ω–¥–∏: {error}",
      },
      successGeneric: {
        en: "Command executed successfully.",
        ru: "–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.",
        uk: "–ö–æ–º–∞–Ω–¥–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ.",
      },
    },
    collector: {
      contextClear: {
        success: {
          en: "Conversation context cleared!",
          ru: "–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω!",
          uk: "–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥—ñ–∞–ª–æ–≥—É –æ—á–∏—â–µ–Ω–∏–π!",
        },
      },
      modelChange: {
        success: {
          en: "Model changed to `{model}`. This will be used for your next request.",
          ru: "–ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ `{model}`. –≠—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.",
          uk: "–ú–æ–¥–µ–ª—å –∑–º—ñ–Ω–µ–Ω–∞ –Ω–∞ `{model}`. –¶–µ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –≤–∞—à–æ–≥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É.",
        },
      },
    },
    sanitization: {
      // Optional: Keep these internal?
      mention: { en: "(mention)", ru: "(—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ)", uk: "(—É–ø–æ–º–∏–Ω–∞–Ω–Ω—è)" },
      everyone: { en: "@ everyone", ru: "@ –≤—Å–µ—Ö", uk: "@ –≤—Å—ñ—Ö" },
      here: { en: "@ here", ru: "@ –∑–¥–µ—Å—å", uk: "@ —Ç—É—Ç" },
    },
    finetune: {
      buttonLabel: {
        en: "Fine-tune Settings",
        ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤",
      },
      selectParameter: {
        en: "Select parameter to adjust",
        ru: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        uk: "–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
      },
      selectParameterPrompt: {
        en: "Select an AI parameter to adjust:",
        ru: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –ò–ò –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:",
        uk: "–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –®–Ü –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:",
      },
      parameterUpdated: {
        en: "{parameter} updated to {value}.",
        ru: "{parameter} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {value}.",
        uk: "{parameter} –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ {value}.",
      },
      selectionTimeout: {
        en: "Parameter selection timed out.",
        ru: "–í—Ä–µ–º—è –≤—ã–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏—Å—Ç–µ–∫–ª–æ.",
        uk: "–ß–∞—Å –≤–∏–±–æ—Ä—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è.",
      },
      modalTitle: {
        en: "Fine-tune AI Parameters",
        ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ò–ò",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –®–Ü",
      },
      modalTitlePage2: {
        en: "Fine-tune AI Parameters (Page 2)",
        ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ò–ò (–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2)",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –®–Ü (–°—Ç–æ—Ä—ñ–Ω–∫–∞ 2)",
      },
      processingFirstSet: {
        en: "Processing first set of parameters... Please fill in the remaining parameters.",
        ru: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.",
        uk: "–û–±—Ä–æ–±–∫–∞ –ø–µ—Ä—à–æ–≥–æ –Ω–∞–±–æ—Ä—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤... –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ä–µ—à—Ç—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.",
      },
      chooseOption: {
        en: "Please choose an option below:",
        ru: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –Ω–∏–∂–µ:",
        uk: "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—é –Ω–∏–∂—á–µ:",
      },
      configureMore: {
        en: "Configure More Parameters",
        ru: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –±—ñ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤",
      },
      saveCurrentSettings: {
        en: "Save Current Settings",
        ru: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        uk: "–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
      },
      resetToDefaults: {
        en: "Reset to Defaults",
        ru: "–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
        uk: "–°–∫–∏–Ω—É—Ç–∏ –¥–æ –∑–Ω–∞—á–µ–Ω—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º",
      },
      allParametersUpdated: {
        en: "All AI parameters updated successfully!",
        ru: "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ò–ò —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!",
        uk: "–í—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –®–Ü —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω—ñ!",
      },
      firstSetUpdated: {
        en: "First set of parameters saved successfully!",
        ru: "–ü–µ—Ä–≤—ã–π –Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!",
        uk: "–ü–µ—Ä—à–∏–π –Ω–∞–±—ñ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!",
      },
      parametersReset: {
        en: "All AI parameters have been reset to default values!",
        ru: "–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ò–ò –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!",
        uk: "–í—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –®–Ü –±—É–ª–∏ —Å–∫–∏–Ω—É—Ç—ñ –¥–æ –∑–Ω–∞—á–µ–Ω—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º!",
      },
      error: {
        en: "An error occurred while processing your parameters.",
        ru: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.",
        uk: "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –≤–∞—à–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.",
      },
      defaultUpdated: {
        en: "First set of parameters updated by default since no further action was taken.",
        ru: "–ü–µ—Ä–≤—ã–π –Ω–∞–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ç–∞–∫ –∫–∞–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ –±—ã–ª–æ.",
        uk: "–ü–µ—Ä—à–∏–π –Ω–∞–±—ñ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–æ–¥–∞–ª—å—à–∏—Ö –¥—ñ–π –Ω–µ –±—É–ª–æ.",
      },
      parameters: {
        temperature: {
          label: {
            en: "Temperature",
            ru: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
            uk: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
          },
          description: {
            en: "Controls randomness: higher values produce more creative results",
            ru: "–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å: –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–∞—é—Ç –±–æ–ª–µ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            uk: "–ö–æ–Ω—Ç—Ä–æ–ª—é—î –≤–∏–ø–∞–¥–∫–æ–≤—ñ—Å—Ç—å: –≤–∏—â—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–∞—é—Ç—å –±—ñ–ª—å—à —Ç–≤–æ—Ä—á—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏",
          },
        },
        top_p: {
          label: {
            en: "Top P",
            ru: "Top P",
            uk: "Top P",
          },
          description: {
            en: "Nucleus sampling: considers tokens with top_p probability mass",
            ru: "–í—ã–±–æ—Ä–∫–∞ —è–¥—Ä–∞: —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–π –º–∞—Å—Å–æ–π top_p",
            uk: "–í–∏–±—ñ—Ä–∫–∞ —è–¥—Ä–∞: —Ä–æ–∑–≥–ª—è–¥–∞—î —Ç–æ–∫–µ–Ω–∏ –∑ —ñ–º–æ–≤—ñ—Ä–Ω—ñ—Å–Ω–æ—é –º–∞—Å–æ—é top_p",
          },
        },
        top_k: {
          label: {
            en: "Top K",
            ru: "Top K",
            uk: "Top K",
          },
          description: {
            en: "Only sample from the K most likely tokens",
            ru: "–í—ã–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑ K –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤",
            uk: "–í–∏–±—ñ—Ä–∫–∞ —Ç—ñ–ª—å–∫–∏ –∑ K –Ω–∞–π–±—ñ–ª—å—à –π–º–æ–≤—ñ—Ä–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤",
          },
        },
        frequency_penalty: {
          label: {
            en: "Frequency Penalty",
            ru: "–®—Ç—Ä–∞—Ñ —á–∞—Å—Ç–æ—Ç—ã",
            uk: "–®—Ç—Ä–∞—Ñ —á–∞—Å—Ç–æ—Ç–∏",
          },
          description: {
            en: "Decreases repetition of frequent tokens",
            ru: "–£–º–µ–Ω—å—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —á–∞—Å—Ç—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤",
            uk: "–ó–º–µ–Ω—à—É—î –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è —á–∞—Å—Ç–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤",
          },
        },
        presence_penalty: {
          label: {
            en: "Presence Penalty",
            ru: "–®—Ç—Ä–∞—Ñ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è",
            uk: "–®—Ç—Ä–∞—Ñ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç—ñ",
          },
          description: {
            en: "Decreases repetition of used tokens",
            ru: "–£–º–µ–Ω—å—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤",
            uk: "–ó–º–µ–Ω—à—É—î –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤",
          },
        },
        repetition_penalty: {
          label: {
            en: "Repetition Penalty",
            ru: "–®—Ç—Ä–∞—Ñ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è",
            uk: "–®—Ç—Ä–∞—Ñ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è",
          },
          description: {
            en: "Higher values prevent repetition",
            ru: "–ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ",
            uk: "–í–∏—â—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞–ø–æ–±—ñ–≥–∞—é—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—é",
          },
        },
        min_p: {
          label: {
            en: "Min P",
            ru: "Min P",
            uk: "Min P",
          },
          description: {
            en: "Only tokens with at least this probability are considered",
            ru: "–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –Ω–µ –º–µ–Ω—å—à–µ —ç—Ç–æ–π",
            uk: "–†–æ–∑–≥–ª—è–¥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —Ç–æ–∫–µ–Ω–∏ –∑ —ñ–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—é –Ω–µ –º–µ–Ω—à–µ —Ü—ñ—î—ó",
          },
        },
        top_a: {
          label: {
            en: "Top A",
            ru: "Top A",
            uk: "Top A",
          },
          description: {
            en: "Dynamic nucleus sampling threshold",
            ru: "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –≤—ã–±–æ—Ä–∫–∏ —è–¥—Ä–∞",
            uk: "–î–∏–Ω–∞–º—ñ—á–Ω–∏–π –ø–æ—Ä—ñ–≥ –≤–∏–±—ñ—Ä–∫–∏ —è–¥—Ä–∞",
          },
        },
        max_completion_tokens: {
          label: {
            en: "Max Tokens",
            ru: "–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤",
            uk: "–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω—ñ–≤",
          },
          description: {
            en: "Maximum number of tokens to generate",
            ru: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏",
            uk: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó",
          },
        },
      },
    },
    reasoning: {
      buttonLabel: {
        en: "Reasoning Settings",
        ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
      },
      selectParameter: {
        en: "Configure reasoning",
        ru: "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
      },
      settingsUpdated: {
        en: "Reasoning settings updated: Effort={effort}, Max Tokens={maxTokens}, Exclude={exclude}",
        ru: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã: –£—Å–∏–ª–∏–µ={effort}, –ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤={maxTokens}, –ò—Å–∫–ª—é—á–∏—Ç—å={exclude}",
        uk: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—ñ: –ó—É—Å–∏–ª–ª—è={effort}, –ú–∞–∫—Å. —Ç–æ–∫–µ–Ω—ñ–≤={maxTokens}, –í–∏–∫–ª—é—á–∏—Ç–∏={exclude}",
      },
      error: {
        en: "An error occurred while updating reasoning settings.",
        ru: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è.",
        uk: "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è.",
      },
      parameters: {
        effort: {
          label: {
            en: "Reasoning Effort",
            ru: "–£—Å–∏–ª–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è",
            uk: "–ó—É—Å–∏–ª–ª—è –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
          },
          description: {
            en: "Controls how much reasoning the model should do",
            ru: "–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –º–Ω–æ–≥–æ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –¥–æ–ª–∂–Ω–∞ –¥–µ–ª–∞—Ç—å –º–æ–¥–µ–ª—å",
            uk: "–ö–æ–Ω—Ç—Ä–æ–ª—é—î, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ –±–∞–≥–∞—Ç–æ –º—ñ—Ä–∫—É–≤–∞–Ω—å –ø–æ–≤–∏–Ω–Ω–∞ —Ä–æ–±–∏—Ç–∏ –º–æ–¥–µ–ª—å",
          },
        },
        maxTokens: {
          label: {
            en: "Max Reasoning Tokens",
            ru: "–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è",
            uk: "–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω—ñ–≤ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
          },
          description: {
            en: "Maximum tokens to use for reasoning",
            ru: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è",
            uk: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
          },
        },
        exclude: {
          label: {
            en: "Exclude Reasoning",
            ru: "–ò—Å–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ",
            uk: "–í–∏–∫–ª—é—á–∏—Ç–∏ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è",
          },
          description: {
            en: "Whether to exclude reasoning from the response",
            ru: "–ò—Å–∫–ª—é—á–∞—Ç—å –ª–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞",
            uk: "–ß–∏ –≤–∏–∫–ª—é—á–∞—Ç–∏ –º—ñ—Ä–∫—É–≤–∞–Ω–Ω—è –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ",
          },
        },
      },
    },
    stream: {
      stop: {
        en: "Stop",
        ru: "–°—Ç–æ–ø",
        uk: "–°—Ç–æ–ø",
      },
    },
  },
};
// --- End Localization Definitions ---

function validateEnvironment() {
  let isValid = true;
  const missingVars = [];

  if (!process.env.GROQ_API) {
    console.error("‚ö†Ô∏è Missing GROQ_API environment variable");
    missingVars.push("GROQ_API");
    isValid = false;
  }

  if (!process.env.OPENROUTER_API_KEY) {
    console.warn(
      "‚ö†Ô∏è Missing OPENROUTER_API_KEY environment variable. OpenRouter models will not be available."
    );
  }

  if (missingVars.length > 0 && !process.env.OPENROUTER_API_KEY) {
    console.error(
      `‚ùå AI module cannot function without at least one API key: ${missingVars.join(
        ", "
      )} or OPENROUTER_API_KEY`
    );
    isValid = false;
  } else if (missingVars.length > 0) {
    console.log(
      `‚ö†Ô∏è AI module running with missing optional keys: ${missingVars.join(
        ", "
      )}. Some providers may be unavailable.`
    );
  } else {
    console.log("‚úÖ AI module environment variables validated");
  }

  return isValid;
}

validateEnvironment();

// --- Start MessageCreate Handler Localization ---
export default {
  name: Events.MessageCreate,
  localization_strings: localization_strings, // Add the strings object to the export
  async execute(message) {
    // Initialize AI clients if not already done
    if (!message.client._aiClientsChecked) {
      message.client._aiClientsChecked = true;
      await initializeApiClients(message.client);
    }

    if (message.author.bot) return;

    const userId = message.author.id;

    console.log(
      `Message received from ${
        message.author.tag
      }: "${message.content.substring(0, 50)}${
        message.content.length > 50 ? "..." : ""
      }"`
    );

    if (!message.mentions.users.has(message.client.user.id)) {
      console.log("Message doesn't mention bot, ignoring");
      return;
    }

    const messageContent = message.content
      .replace(new RegExp(`<@!?${message.client.user.id}>`, "g"), "")
      .trim();

    if (!messageContent && message.attachments.size === 0) {
      console.log("Message only contains ping, no content or attachments");
      return;
    }

    const prefs = getUserPreferences(userId);
    console.log(`User preferences for ${userId}:`, {
      selectedModel: prefs.selectedModel,
      systemPromptEnabled: prefs.systemPromptEnabled,
      toolsEnabled: prefs.toolsEnabled,
    });

    // Determine locale early for potential messages
    let effectiveLocale = "en";
    try {
      const userDbLocale = await hubClient.getUserLocale(
        message.guild?.id,
        userId
      );
      if (userDbLocale && ["en", "ru", "uk"].includes(userDbLocale)) {
        effectiveLocale = userDbLocale;
      } else if (message.guild?.preferredLocale) {
        const normalizedGuildLocale = message.guild.preferredLocale
          .split("-")[0]
          .toLowerCase();
        if (["en", "ru", "uk"].includes(normalizedGuildLocale)) {
          effectiveLocale = normalizedGuildLocale;
        }
      }
    } catch (dbError) {
      console.error(
        `Error fetching user locale for ${userId}, defaulting to 'en':`,
        dbError
      );
    }
    // Set locale for subsequent i18n calls within this scope if needed
    i18n.setLocale(effectiveLocale);

    const isVisionRequest =
      message.attachments.size > 0 &&
      message.attachments.first().contentType?.startsWith("image/");

    if (isVisionRequest) {
      console.log(
        `Vision request detected with attachment: ${
          message.attachments.first().name
        }`
      );
    }

    if (!prefs.selectedModel) {
      console.log(
        `User ${userId} has no model selected. Prompting for selection.`
      );
      message.channel.sendTyping();

      try {
        const client = message.client; // Get client object
        const availableModels = await getAvailableModels(
          client,
          isVisionRequest ? "vision" : null
        );
        console.log(`Found ${availableModels.length} available models`);

        if (availableModels.length === 0) {
          // Use determined locale for the reply
          await message.reply(
            await i18n.__(
              "events.ai.messages.noModelsFound",
              { vision: isVisionRequest ? "vision" : "text" },
              effectiveLocale
            )
          );
          return;
        }

        // Pass client to buildInteractionComponents
        const components = await buildInteractionComponents(
          userId,
          availableModels,
          isVisionRequest,
          true,
          effectiveLocale,
          message.client // Pass client parameter
        );

        console.log("Sending model selection prompt");
        // Use locale for the prompt message
        let promptMsg = await message.reply({
          content: await i18n.__(
            "events.ai.messages.selectModelPrompt",
            effectiveLocale
          ),
          components: components,
        });

        state.pendingInteractions[userId] = message;
        console.log(`Stored pending interaction for user ${userId}`);

        const collector = promptMsg.createMessageComponentCollector({
          filter: (i) => i.user.id === userId,
          time: 5 * 60 * 1000,
        });

        console.log(`Created message component collector for user ${userId}`);

        collector.on("collect", async (interaction) => {
          console.log(
            `Initial Collector: Received interaction - Type: ${interaction.componentType}, Custom ID: ${interaction.customId}, User: ${interaction.user.id}`
          );

          const customId = interaction.customId;

          if (
            interaction.isStringSelectMenu() &&
            customId.startsWith("ai_select_model_")
          ) {
            console.log(
              "Initial Collector: Handling StringSelectMenu interaction."
            );
            const selectedModelId = interaction.values[0];
            console.log(
              `Initial Collector: Raw selected value: ${selectedModelId}`
            );

            // Immediately defer the update to show loading state
            await interaction.deferUpdate().catch((err) => {
              console.error("Initial Collector: Failed to defer update:", err);
            });
            console.log("Initial Collector: Interaction deferred.");

            updateUserPreference(userId, "selectedModel", selectedModelId);
            console.log(
              `Initial Collector: User ${userId} preference updated to model: ${selectedModelId}`
            );

            const originalMessage = state.pendingInteractions[userId];
            if (originalMessage) {
              console.log(
                `Initial Collector: Found pending message ${originalMessage.id}.`
              );
              delete state.pendingInteractions[userId];
              collector.stop("model_selected");
              console.log("Initial Collector: Stopped collector.");

              try {
                // Use locale for the edit message - no need to defer again
                await promptMsg
                  .edit({
                    content: await i18n.__(
                      "events.ai.messages.modelSelectedProcessing",
                      { model: selectedModelId },
                      effectiveLocale
                    ),
                    components: [],
                  })
                  .catch((err) => {
                    console.error(
                      "Initial Collector: Failed to update prompt message:",
                      err
                    );
                  });
                console.log(
                  `Initial Collector: Edited prompt message ${promptMsg.id}.`
                );
              } catch (updateError) {
                console.error(
                  "Initial Collector: Error deferring/editing interaction/prompt message: ",
                  updateError
                );
                // Use locale for the fallback message
                await message.channel
                  .send(
                    await i18n.__(
                      "events.ai.messages.modelSelectedProcessing",
                      { model: selectedModelId },
                      effectiveLocale
                    )
                  )
                  .catch((e) =>
                    console.error("Failed to send fallback message:", e)
                  );
                promptMsg = null;
              }

              const messageContent = originalMessage.content
                .replace(
                  new RegExp(`<@!?${originalMessage.client.user.id}>`, "g"),
                  ""
                )
                .trim();
              const isVisionRequest =
                originalMessage.attachments.size > 0 &&
                originalMessage.attachments
                  .first()
                  .contentType?.startsWith("image/");

              console.log("Initial Collector: Calling processAiRequest...");
              await processAiRequest(
                originalMessage,
                userId,
                messageContent,
                isVisionRequest,
                promptMsg,
                effectiveLocale // Pass locale here
              );
              console.log("Initial Collector: processAiRequest call finished.");
            } else {
              console.warn(
                `Initial Collector: No pending message found for user ${userId} after model selection.`
              );
              try {
                await interaction.update({
                  content: await i18n.__("events.ai.messages.modelSelected", {
                    model: selectedModelId,
                  }),
                  components: [],
                });
              } catch (e) {
                console.error(
                  "Couldn't update interaction after model selection (no pending message)",
                  e
                );
              }
            }
          } else {
            console.log(
              `Initial Collector: Interaction ${customId} is not the model select menu. Ignoring in this collector.`
            );
          }

          // NOTE: Removed toggle and retry button logic from this initial collector.
          // They are now handled by the collector attached in sendResponse.
        });

        collector.on("end", async (collected, reason) => {
          console.log(
            `Collector for ${userId} ended with reason: ${reason}, collected ${collected.size} interactions`
          );

          if (
            reason === "time" &&
            state.pendingInteractions[userId] === message
          ) {
            delete state.pendingInteractions[userId];
            if (collected.size === 0) {
              // Use locale for the timeout message
              promptMsg
                .edit({
                  content: await i18n.__(
                    "events.ai.messages.selectionTimeout",
                    effectiveLocale
                  ),
                  components: [],
                })
                .catch(async (e) =>
                  console.error("Failed to edit timeout message:", e)
                );
              console.log(`Pending interaction timed out for user ${userId}`);
            }
          }
        });
      } catch (error) {
        console.error("Error during model selection process:", error);
        // Use locale for the error message
        await message
          .reply(
            await i18n.__("events.ai.messages.selectionError", effectiveLocale)
          )
          .catch((e) => {});
      }

      return; // Stop processing, wait for interaction
    }

    // Check if selected model is rate-limited
    if (prefs.selectedModel) {
      if (isModelRateLimited(prefs.selectedModel)) {
        // Get the remaining time from state
        const expireTime = state.modelStatus.rateLimits[prefs.selectedModel];
        const now = Date.now();
        const minutes = Math.ceil((expireTime - now) / 1000 / 60); // in minutes

        await message.reply(
          await i18n.__(
            "events.ai.messages.rateLimited",
            {
              model: prefs.selectedModel,
              minutes: minutes,
            },
            effectiveLocale
          )
        );
        return;
      }
    }

    console.log(
      `Processing message from ${message.author.tag} with model ${prefs.selectedModel}`
    );
    // Pass effectiveLocale to processAiRequest
    await processAiRequest(
      message,
      userId,
      messageContent,
      isVisionRequest,
      null,
      effectiveLocale
    );
  },
};
// --- End MessageCreate Handler Localization ---

// User preferences now managed in src/state/prefs.js
// Model capabilities and API client are imported from services/groqModels.js
